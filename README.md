# GCP V2Ray/Xray с Управлением Пользователями и Лимитами

Этот проект представляет собой модифицированный сервер V2Ray/Xray, предназначенный для развертывания в Google Cloud Run. Он включает в себя HTTP API для управления пользователями, а также механизмы для установки ограничений по трафику и времени использования для каждого пользователя.

## Основные возможности

-   **Веб UI Панель Управления**: Удобный интерфейс для управления пользователями и настройками.
-   Динамическое создание, обновление и удаление пользователей V2Ray.
-   Установка индивидуальных лимитов на трафик (в ГБ).
-   Установка индивидуальных временных лимитов (в днях с момента создания).
-   Автоматическая деактивация пользователей при превышении лимитов.
-   Хранение конфигурации пользователей в Google Cloud Storage (GCS) для персистентности.
-   Автоматический перезапуск V2Ray с обновленной конфигурацией при изменении пользователей или их статуса.
-   Защита API и UI с помощью JWT аутентификации (логин/пароль администратора).

## UI Панель Управления

Веб-интерфейс панели управления доступен по пути `/ui/` после развертывания сервиса (например, `https://your-app-url/ui/`).
Для входа в панель используйте учетные данные, заданные переменными окружения `ADMIN_USERNAME` и `ADMIN_PASSWORD`.

Панель позволяет выполнять все CRUD-операции над пользователями, а также генерировать для них **VLESS-ссылки** и QR-коды для быстрой настройки клиентов. Сервер использует протокол VLESS через WebSocket (путь `/v2ray`).

## Переменные окружения

Для конфигурации сервиса используются следующие переменные окружения:

-   `GCS_BUCKET_NAME` (обязательно): Имя бакета Google Cloud Storage, где будет храниться JSON-файл с данными пользователей.
-   `GCS_OBJECT_NAME` (обязательно): Имя объекта (файла) в бакете GCS (например, `v2ray_users.json`).
-   `PORT` (предоставляется Cloud Run): Порт, на котором будет слушать основной сервис V2Ray (для клиентских подключений).
-   `API_PORT` (опционально, по умолчанию `8000`): Порт, на котором будет работать HTTP API для управления пользователями и статика UI.
-   `TRAFFIC_CHECK_INTERVAL_SECONDS` (опционально, по умолчанию `300`): Интервал в секундах для проверки лимитов трафика и времени пользователей.
-   `ADMIN_USERNAME` (опционально, по умолчанию `admin`): Имя пользователя для доступа к API и UI панели управления.
-   `ADMIN_PASSWORD` (опционально, по умолчанию `password`): Пароль для доступа к API и UI панели управления. **Настоятельно рекомендуется изменить значение по умолчанию!**
-   `JWT_SECRET_KEY` (обязательно): Секретный ключ для подписи JWT токенов. Должен быть надежной случайной строкой. Сервис не запустится без этого ключа.
-   `GOOGLE_APPLICATION_CREDENTIALS` (опционально): Путь к файлу ключа сервисного аккаунта JSON. В Cloud Run обычно настраивается автоматически через сервисный аккаунт самого сервиса.

## Настройка Google Cloud Storage (GCS)

1.  Создайте бакет в GCS.
2.  Убедитесь, что сервисный аккаунт, от имени которого запускается ваш сервис Cloud Run, имеет права на чтение и запись объектов в этот бакет (роли "Storage Object User" или "Storage Object Admin").
3.  При первом запуске сервис попытается загрузить файл конфигурации пользователей из `gs://<GCS_BUCKET_NAME>/<GCS_OBJECT_NAME>`. Если файл не найден, будет создана пустая конфигурация.

## API для управления пользователями

API доступно на порту, указанном в `API_PORT`. Все эндпоинты управления пользователями (начинающиеся с `/api/users` или `/api/user`) требуют JWT аутентификации (Bearer Token в заголовке `Authorization`). Эндпоинт входа `/api/auth/login` публичен.

### 0. Вход в систему (Получение JWT токена)
-   **Метод**: `POST`
-   **Путь**: `/api/auth/login`
-   **Тело запроса** (JSON): `{"username": "ваше_имя_админа", "password": "ваш_пароль_админа"}`
-   **Ответ**: `200 OK` с JSON `{"token": "jwt_токен"}` или `401 Unauthorized`.

### 1. Получить список всех пользователей
-   **Метод**: `GET`
-   **Путь**: `/api/users`
-   **Ответ**: `200 OK`
    ```json
    [
      {
        "id": "uuid-пользователя-1",
        "traffic_limit_gb": 10,
        "time_limit_days": 30,
        "created_at": "2023-10-27T10:00:00Z",
        "traffic_used_bytes": 500000000,
        "is_active": true
      },
      // ... другие пользователи
    ]
    ```

### 2. Создать нового пользователя
-   **Метод**: `POST`
-   **Путь**: `/api/users`
-   **Тело запроса** (JSON):
    ```json
    {
      "traffic_limit_gb": 20.5, // Лимит трафика в ГБ
      "time_limit_days": 60     // Срок жизни пользователя в днях
    }
    ```
-   **Ответ**: `201 Created`
    ```json
    {
      "id": "сгенерированный-uuid",
      "traffic_limit_gb": 20.5,
      "time_limit_days": 60,
      "created_at": "2023-10-27T12:00:00Z",
      "traffic_used_bytes": 0,
      "is_active": true
    }
    ```

### 3. Получить информацию о конкретном пользователе
-   **Метод**: `GET`
-   **Путь**: `/api/user?id={userID}`
-   **Ответ**: `200 OK` (тело как в п.1 для одного пользователя) или `404 Not Found`.

### 4. Обновить пользователя
-   **Метод**: `PUT`
-   **Путь**: `/api/user?id={userID}`
-   **Тело запроса** (JSON, можно обновлять выборочные поля):
    ```json
    {
      "traffic_limit_gb": 25,
      "time_limit_days": 90,
      "is_active": true,
      "traffic_used_bytes": 0 // Можно сбросить счетчик трафика
    }
    ```
-   **Ответ**: `200 OK` (обновленные данные пользователя) или `404 Not Found`.
    *Примечание: `id` и `created_at` не могут быть изменены.*

### 5. Удалить пользователя
-   **Метод**: `DELETE`
-   **Путь**: `/api/user?id={userID}`
-   **Ответ**: `204 No Content` или `404 Not Found`.

## Механизм ограничений

-   **Ограничения по трафику**: Сервис периодически (согласно `TRAFFIC_CHECK_INTERVAL_SECONDS`) опрашивает V2Ray StatsService API для получения данных об использованном трафике каждым пользователем. Если пользователь превышает `traffic_limit_gb`, его поле `is_active` устанавливается в `false`, конфигурация V2Ray обновляется, и пользователь отключается.
-   **Ограничения по времени**: С тем же интервалом проверяется срок жизни пользователя (`time_limit_days` с момента `created_at`). При истечении срока пользователь также деактивируется.

## Развертывание в Google Cloud Run

1.  Склонируйте репозиторий.
2.  Убедитесь, что ваш Google Cloud Project настроен и `gcloud` CLI аутентифицирован.
3.  Соберите Docker-образ:
    ```bash
    gcloud builds submit --tag gcr.io/YOUR_PROJECT_ID/v2ray-manager
    ```
4.  Разверните сервис в Cloud Run:
    ```bash
    gcloud run deploy v2ray-manager \
      --image gcr.io/YOUR_PROJECT_ID/v2ray-manager \
      --platform managed \
      --region YOUR_REGION \
      --allow-unauthenticated \ # Если V2Ray должен быть доступен публично
      --set-env-vars="GCS_BUCKET_NAME=your-gcs-bucket" \
      --set-env-vars="GCS_OBJECT_NAME=v2ray_users.json" \
      --set-env-vars="API_PORT=8000" \ # Порт для API и UI
      --set-env-vars="ADMIN_USERNAME=myadmin" \
      --set-env-vars="ADMIN_PASSWORD=mypassword" \
      --set-env-vars="JWT_SECRET_KEY=your_super_secret_random_key" \
      # --set-env-vars "TRAFFIC_CHECK_INTERVAL_SECONDS=600" # Пример
      --port 8080 # Это порт для V2Ray (`$PORT` в Dockerfile)
    ```
    *Замените `YOUR_PROJECT_ID`, `YOUR_REGION`, `your-gcs-bucket` и другие параметры на свои.*
    *Порт, указанный в `--port` (здесь `8080`), будет портом для V2Ray. `API_PORT` (здесь `8000`) будет использоваться для API управления и для доступа к UI по пути `/ui/`.*

## Локальный запуск (для разработки)

1.  Настройте эмулятор GCS или реальный GCS бакет.
2.  Установите переменные окружения.
3.  Соберите и запустите Docker-образ локально:
    ```bash
    docker build -t v2ray-manager .
    docker run -p 8080:8080 -p 8000:8000 \
      -e GCS_BUCKET_NAME="your-bucket" \
      -e GCS_OBJECT_NAME="users.json" \
      -e PORT="8080" \
      -e API_PORT="8000" \
      -e ADMIN_USERNAME="admin" \
      -e ADMIN_PASSWORD="password" \
      -e JWT_SECRET_KEY="localsecretkey" \
      # -e GOOGLE_APPLICATION_CREDENTIALS="/path/to/credentials.json" # Если нужно для локального GCS доступа
      v2ray-manager
    ```
    После запуска UI будет доступен по адресу `http://localhost:8000/ui/`.